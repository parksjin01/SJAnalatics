# -*- encoding:utf-8 -*-
import sys
reload(sys)
sys.setdefaultencoding('utf-8')

import urllib2
import BeautifulSoup
import datetime
import time
import cPickle

def code_to_cid(stock_number):
    page = urllib2.urlopen('https://www.google.com/finance/historical?q=KRX%3A'+str(stock_number)+'&ei=SJdbWbjAHIva0QTMxYm4Bg')
    soup = BeautifulSoup.BeautifulSoup(page)
    cid = soup.findAll('input', attrs={'type':'hidden', 'name':'cid'})[0]
    return cid['value']

def crawl_stock(stock_number='', number_get=50, start_date=''):
    if start_date == '':
        start_date = datetime.datetime.now().strftime("%b %d %Y").split(' ')
        start_date[1] = str(int(start_date[1]))
        start_date = start_date[0]+'+'+start_date[1]+'%2C+'+start_date[2]
    if stock_number == '':
        assert 1==2
    cid = code_to_cid(stock_number)
    page = urllib2.urlopen('https://www.google.com/finance/historical?cid='+unicode(cid)+'&enddate='+unicode(start_date)+'&num='+unicode(number_get)+'&ei=WYVbWYCUI4va0QTMxYm4Bg').read()
    soup = BeautifulSoup.BeautifulSoup(page)
    page = str(soup.findAll('div', attrs={'id':'prices'})[0])
    table = []
    table_header = []
    soup = BeautifulSoup.BeautifulSoup(page)
    for th in soup.findAll('th'):
        table_header.append(th.text)
    table.append(table_header)
    table_contents = soup.findAll('td')
    for idx in range(0, len(table_contents)/6):
        tmp = [table_contents[idx*6].text, table_contents[idx*6+1].text, table_contents[idx*6+2].text, table_contents[idx*6+3].text, table_contents[idx*6+4].text, table_contents[idx*6+5].text]
        table.append(tmp)
    return table

company = ['251270', '035420', '005930', '005935', '028260', '032830', '207940', '000815', '000810', '018260', '006405', '006400', '000835', '000830', '009155', '009150', "066575", "066570", "051915", "051910", "051905", "051900", "034220", "003555", "003550", "032640", "011070", "241560", "000157", "000155", "000150", "034020", "042670", "011160", "082740", "023530", "011170", "004990", "005300", "005305", "071840", "004000", "004010", "002270", "000400", "032350", "005389", "005385", "005380", "005387", "012330", "012335", "009540", "004020", "086280", "000725", "000720", "267250", "001450", "012630", "011200", "000660", "017670", "034730", "03473K", "096775", "096770", "003605", "003600", "005490", "047050", "051310", "058430", "006260", "010120", "180640", "117930", "097230", "002320", "003480", "005830", "000990", "000995", "016380", "012030", "005960", "016385", "005965", "000997", "016610", "083390", "083380", "083370", "083350", "080960", "010950", "010955", "000030", "053000", "010050", "122260", "122750", "123930", "118000", "004720", "104530", "104520", "000210", "000215", "005750", "006570", "004440", "055550", "005450", "500001", "500002", "500004", "500003", "500015", "500018", "500014", "500010", "500013", "500019", "500011", "500008", "500007", "500006", "500012", "095570", "068400", "152100", "253160", "253150", "161520", "190150", "239660", "161550", "256450", "161490", "251590", "251600", "161510", "161540", "141240", "227830", "141250", "161500", "266550", "269530", "222170", "269540", "222190", "222200", "238670", "222180", "189400", "204420", "195970", "195980", "213630", "161530", "190160", "263190", "244820", "236460", "101140", "017900", "161000", "016570", "033660", "002797", "008705", "008700", "950100", "183190", "002030", "083610", "081930", "083580", "083590", "083600", "081200", "081210", "082250", "082260", "080180", "083570", "083620", "081190", "082240", "081940", "009385", "009380", "000895", "001465", "092630", "155900", "014580", "035150", "005180", "002760", "001270", "001275", "026940", "004740", "002410", "015350", "002535", "900050", "120030", "011155", "73801A72", "26490K", "000590", "006380", "950070", "002787", "002785", "002780", "010640", "001550", "002600", "000480", "000650", "005070", "005420", "264900", "005745", "112610", "004555", "121910", "024090", "008970", "008975", "155660", "069730", "013570", "210540", "000430", "092200", "012800", "012805", "015230", "008060", "004130", "004135", "006375", "001130", "084010", "003830", "006570", "001689", "084695", "117580", "005620", "128820", "006345", "009320", "004550", "510001", "020120", "145720", "026890", "002150", "002690", "003580", "058730", "028100", "007340", "007590", "007595", "005965", "005960", "016610", "016385", "083360", "080980", "083390", "083370", "080030", "080970", "083350", "083380", "080960", "001530", "004890", "023450", "102260", "030720", "084670", "082740", "016740", "004835", "074610", "001200", "007700", "036580", "010460", "035000", "013870", "001250", "011420", "000500", "001290", "123690", "122090", "00088K", "001500", "006060", "012335", "003450", "003010", "195870", "060980", "7420170C", "74201773", "74201767", "74202767", "099340", "099350", "009460", "143210", "002220", "003480", "097230", "002320", "017960", "002000", "002005", "002300", "042700", "011500", "004965", "011700", "007197", "007195", "010420", "003530", "003535", "001755", "001750", "012405", "003280", "000545", "000540", "000547", "215620", "071090", "000145", "111110", "013520", "005010", "000850", "032560", "241590", "002460", "094280", "004560", "004565", "126560", "010520", "039570", "74701772", "74702772", "003120", "249420", "007110", "000230", "008500", "081000", "020760", "013367", "013360", "034590", "129260", "234080", "033240", "006220", "580005", "021960", "580001", "580007", "580004", "123760", "580006", "580003", "580002", "71901A58", "148020", "252410", "252420", "252400", "174360", "250730", "136340", "183710", "140570", "183700", "253280", "253290", "266160", "196220", "270810", "272570", "252730", "252720", "140580", "219390", "272560", "196230", "267500", "267490", "267450", "267440", "234310", "241390", "119650", "001390", "226380", "272910", "211260", "105270", "196030", "238720", "227930", "251890", "234790", "190620", "256440", "261920", "265690", "219900", "181450", "205720", "181480", "131890", "232590", "225130", "245710", "105190", "104700", "001940", "090540", "176950", "252650", "252670", "223190", "237350", "226980", "273130", "273140", "244580", "256750", "099140", "204450", "266390", "266410", "211900", "237370", "271060", "247790", "266420", "266370", "266360", "229200", "251340", "233740", "226490", "214980", "229720", "251350", "244620", "244660", "269420", "219480", "200050", "185680", "218420", "200040", "200030", "200020", "213610", "247800", "261240", "261270", "261260", "261250", "247780", "244670", "271050", "261220", "00781K", "KOSDI", "KODI-I", "153270", "253240", "253230", "253250", "260200", "260270", "200250", "230480", "225800", "KOSPI100", "KOSPI200", "KOSPI200-I", "KOSPI50", "KOSPI-8", "KOSPI-20", "KOSPI", "KOSPI-I", "KOSPI-18", "KOSPI-16", "KOSPI-13", "KOSPI-17", "KOSPI-22", "KOSPI-25", "KOSPI-24", "KOSPI-21", "KOSPI-5", "KOSPI-11", "KOSPI-2", "KOSPI-12", "KOSPI-27", "KOSPI-14", "KOSPI-9", "KOSPI-3", "KOSPI-10", "KOSPI-7", "KOSPI-26", "KOSPI-4", "KOSPI-6", "KOSPI-19", "KOSPI-15", "KOSPI100EW-I", "KOSPI100EW", "KOSPI200SECTOR-1", "KOSPI200SECTOR-I1", "KOSPI200SECTOR-8", "KOSPI200SECTOR-I8", "KOSPI200SECTOR-I7", "KOSPI200SECTOR-4", "KOSPI200SECTOR-I4", "KOSPI200EW-I", "KOSPI200EW", "KOSPI200SECTOR-I6", "KOSPI200SECTOR-7", "KOSPI200SECTOR-2", "KOSPI200SECTOR-I2", "KOSPI200SECTOR-5", "KOSPI200SECTOR-I5", "KOSPI200SECTOR-6", "KOSPI200SECTOR-3", "KOSPI200SECTOR-I3", "KOSPI50EW-I", "KOSPI50EW", "025000", "083420", "092230", "KRX100", "KRX100-I", "KRXSECTOR-1", "KRXSECTOR-1I", "KRXSECTOR-10", "KRXSECTOR-10I", "KRXSECTOR-8", "KRXSECTOR-8I", "KRXSECTOR-6", "KRXSECTOR-6I", "KRXSECTOR-4", "KRXSECTOR-4I", "KRXGRNEST", "KRXGREEN", "KRXSECTOR-3", "KRXSECTOR-3I", "KRXSECTOR-5", "KRXSECTOR-5I", "KRXSECTOR-14", "KRXSECTOR-14I", "KRXSECTOR-17", "KRXSECTOR-17I", "KRXSECTOR-13", "KRXSECTOR-9", "KRXSECTOR-9I", "KRXSECTOR-11", "KRXSECTOR-11I", "KRXSECTOR-16", "KRXSECTOR-16I", "KOGI-I", "KRXSECTOR-12", "KRXSECTOR-12I", "KRXSECTOR-2", "KRXSECTOR-2I", "KRXSECTOR-13I", "KRXSECTOR-7", "KRXSECTOR-7I", "KRXSECTOR-15", "KRXSECTOR-15I", "KRX100EW-I", "KRX100EW", "044450", "105780", "030210", "168300", "000860", "012205", "002240", "004545", "004540", "026870", "144620", "003075", "005430", "007810", "007815", "KOSPI-ECGI", "023350", "002140", "004090", "010040", "025610", "007280", "096300", "014530", "008870", "001210", "002995", "002990", "014285", "017040", "192530", "013580", "030610", "267290", "009140", "008020", "002100", "000400", "229640", "000685", "000680", "025820", "001080", "74401773", "74401769", "023150", "122390", "114820", "130680", "123310", "123320", "105020", "105010", "74601669", "211210", "117690", "098560", "590009", "520012", "520002", "590018", "520003", "520010", "520004", "520006", "590003", "590004", "590012", "520011", "520005", "520007", "520015", "590011", "590002", "590005", "590006", "520016", "520017", "520018", "520019", "520009", "590010", "520001", "590016", "520014", "520013", "590001", "590017", "590007", "590008", "590013", "094800", "097720", "097710", "134380", "002840", "107590", "268280", "204210", "012690", "008420", "009580", "009680", "71301A1B", "713017R3", "713027R3", "713037R3", "016420", "008260", "009815", "025860", "008350", "008355", "004270", "003920", "003925", "004255", "005720", "005725", "72501773", "72502773", "000327", "000325", "090355", "006090", "737027S7", "176710", "001340", "007980", "001310", "005810", "058430", "192720", "226810", "117740", "129270", "005030", "101990", "010770", "550031", "550023", "550027", "550029", "550011", "550001", "550014", "550018", "550013", "550016", "550032", "550006", "550019", "550005", "550021", "550025", "550009", "550022", "550036", "550034", "550038", "550037", "550040", "550035", "550039", "550026", "550004", "550012", "550030", "550015", "550020", "550007", "550003", "550033", "550008", "550010", "550002", "550024", "000760", "000425", "02826K", "117700", "117680", "001380", "002365", "72501A3B", "72502A3B", "72503A3B", "72504A3B", "104110", "104120", "001515", "001510", "005850", "220130", "SRIECO", "SRIECO-I", "SRI", "SRI-I", "011810", "077970", "071970", "008080", "007160", "014710", "003960", "003965", "009770", "006110", "010960", "004690", "001880", "004450", "004380", "530025", "530026", "530005", "530012", "530014", "006660", "530010", "530004", "530006", "530001", "530024", "530002", "530027", "530028", "530030", "530034", "530035", "530029", "104580", "102970", "102960", "530013", "530007", "530023", "530031", "530008", "530003", "530011", "530009", "530019", "530015", "530020", "530016", "530021", "530017", "530022", "530018", "001820", "009470", "011230", "000365", "023000", "008720", "003230", "003945", "003940", "002170", "005680", "041650", "019440", "058650", "003030", "004365", "004360", "004490", "027970", "075580", "248170", "007610", "034120", "017390", "004410", "004415", "200880", "013005", "001770", "005800", "016590", "500004", "500018", "500013", "500011", "500009", "005450", "500016", "500005", "500008", "500014", "500012", "500010", "500006", "500026", "500022", "500007", "500024", "500003", "500001", "500020", "500019", "500025", "500021", "500017", "500023", "500002", "500015", "014350", "002700", "002870", "019175", "031430", "009270", "009275", "029530", "208470", "007800", "017555", "00341A", "003417", "00341D", "003080", "014915", "004985", "004987", "004989", "136490", "084870", "139220", "227560", "139290", "139250", "243890", "252000", "139270", "267770", "252710", "227540", "139230", "227550", "139260", "243880", "139240", "192090", "245360", "237440", "217790", "228790", "211560", "245340", "245350", "210780", "232080", "250780", "233160", "267300", "261070", "261060", "228820", "174350", "228810", "272580", "203780", "241180", "261140", "227570", "225030", "266140", "217780", "204480", "225060", "225050", "195930", "248270", "182490", "236350", "248260", "195920", "182480", "269370", "225040", "253990", "228800", "261120", "261110", "217770", "570003", "570015", "570013", "570006", "570014", "570004", "570012", "570010", "570018", "570016", "570017", "570001", "570002", "570019", "570009", "570011", "570007", "570008", "570005", "001790", "001795", "009410", "009415", "015890", "001420", "004100", "004105", "001070", "019300", "008900", "134790", "078000", "002420", "001527", "001525", "030790", "122290", "002900", "140890", "108890", "004870", "072130", "011330", "014830", "000910", "077500", "100220", "016580", "024070", "122750", "005820", "049800", "010050", "123930", "104520", "104530", "017370", "070960", "002920", "008730", "014440", "003465", "003460", "097750", "011690", "000225", "000227", "122900"]
# table = crawl_stock(company[0], 200)
# result = []
# content = []
# idx = 1
# for code in company:
#     print idx, code
#     if idx%100 == 1:
#         time.sleep(5)
#     try:
#         table = crawl_stock(code, 200)
#     except Exception, e:
#         idx += 1
#         print 'Error',e
#         continue
#     tmp = []
#     for line in table[1:]:
#         tmp.append(line[4])
#     if tmp[0] >= tmp[1]:
#         result.append(1)
#     else:
#         result.append(0)
#     content.append(tmp[1:])
#     idx += 1
# with open('dataset', 'wb') as f:
#     cPickle.dump([result, content], f)
# print len(company)